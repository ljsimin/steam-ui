<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- The HTML 4.01 Transitional DOCTYPE declaration-->
<!-- above set at the top of the file will set     -->
<!-- the browser's rendering engine into           -->
<!-- "Quirks Mode". Replacing this declaration     -->
<!-- with a "Standards Mode" doctype is supported, -->
<!-- but may lead to some differences in layout.   -->
<link type="text/css" rel="stylesheet" href="/css/reset.css" />
<link type="text/css" rel="stylesheet" href="/css/main.css" />

<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Steam Ui</title>
  </head>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="js/purl.js"></script>
<script src="js/spin.min.js"></script>
<script src="js/underscore-min.js"></script>

  <body>
    <div class="header">
    	<h1 ><span id="player-name"></span> Steam UI beta 4</h1>
    	<span id="spinner-header"></span>
	</div>
	
	<div class="left-column">
		Search: 
		<input name="filter-input" id="filter-input" type="text">
		<ul id="game-list"></ul>
		<div id="spinner-holder"></div>
	</div>
	<div class="right-column">
<!-- 		<iframe id="game-info-frame"></iframe> -->
		<div id="game-info-frame"></div>
	</div>
	
	<script type="text/javascript">	
	var list = new Array();
	var spinnerOpts = {
			  lines: 13, // The number of lines to draw
			  length: 5, // The length of each line
			  width: 5, // The line thickness
			  radius: 25, // The radius of the inner circle
			  corners: 1, // Corner roundness (0..1)
			  rotate: 0, // The rotation offset
			  direction: 1, // 1: clockwise, -1: counterclockwise
			  color: '#000', // #rgb or #rrggbb or array of colors
			  speed: 1, // Rounds per second
			  trail: 60, // Afterglow percentage
			  shadow: false, // Whether to render a shadow
			  hwaccel: false, // Whether to use hardware acceleration
			  className: 'spinner', // The CSS class to assign to the spinner
			  zIndex: 2e9, // The z-index (defaults to 2000000000)
			  top: '100', // Top position relative to parent in px
			  left: '100' // Left position relative to parent in px
			};
	(function getGames() {
// 		  $('.left-column').after(new Spinner(spinnerOpts).spin().el);
		  var urlGames = "/steamui?id="+$.url().param("id")+"&offset="+$('.game').length;
		  console.log(urlGames);
		  $.getJSON( urlGames, {
		  })
		    .done(function(data ) {
				$('#spinner-holder').empty();
		    	if (addItemsToList(data)) {
		    		//if there is data returned call self recursively 
					getGames();
		    	} else {
		    		//finished
		    		console.log("Finshed loading, " + list.length + " items are in the list");
		    	}
		    });
		  var urlPlayer = "/player?id="+$.url().param("id");
		  console.log(urlPlayer);
		  $.getJSON( urlPlayer, {
		  })
		    .done(function(data ) {
		    	$('#player-name').text(data + " - ");
		    });
		})();
	
		function addItemsToList(data) {
			console.log("data length " + data.length)
	    	if (data.length > 0) {	    		
			      $.each(data, function(i, game ) {
			    	//adding game to the internal list
			    	list.push(game);
			    	
			    	//rendering the game in the visual list
			        render(game);
			        
			      });
				  registerClickHandlers();				  
				  return true;
	    	} else {
	    		return false;
	    	}
		}

		function render(game) {
			$("<li/>")
        		.attr("data-appid", game.appid)
        		.attr("data-game-name", game.name)
        		.attr("id", "li-" + game.appid)
        		.addClass("game")
        		.appendTo("#game-list");
			$('<a>')
				.attr('href', "steam://run/"+game.appid)
				.attr("id", "run-" + game.appid)
				.appendTo('#li-'+game.appid);
	        $('<img/>')
	        	.addClass('run-game')
	        	.attr("data-appid", game.appid)
	        	.attr('src', "/image/play-icon.png")
	        	.appendTo('#run-'+game.appid);
	        $('<img/>')
	        	.addClass('game-thumbnail')
	        	.attr('src', "http://media.steampowered.com/steamcommunity/public/images/apps/"+game.appid+"/"+game.img_icon_url+".jpg")
	        	.appendTo('#li-'+game.appid);
	        $('<span>')
	        	.text(game.name)
	        	.addClass("game-name")
	        	.attr("data-appid", game.appid)
	        	.appendTo('#li-'+game.appid);
	        $('<ul>')
	        	.addClass("game-genres")
	    		.addClass("game-genres-"+game.appid)
	    		.appendTo('#li-'+game.appid);
	        $.each(game.genres, function(j, genre) {
	        	$('<li>')
	    			.text(genre)
	    			.addClass("game-genre")
	    			.appendTo(".game-genres-"+game.appid);
        	});
		}
		
		function filter(s) {
			var result = _(list).filter(function (x) { 
				return ~x.searchField.toLowerCase().indexOf(s.toLowerCase()); 
			});
    		$("#game-list").empty();
    		$.each(result, function(i, game ) {
		    	//rendering the game in the visual list
		        render(game);
		        registerClickHandlers();
	        });
		}
		
		function registerClickHandlers() {
			$(".game").unbind().click(function () { 
// 			      $("#game-info-frame").attr("src", "http://store.steampowered.com/app/"+$(this).data('appid'));
// 			      console.log("http://store.steampowered.com/app/"+$(this).data('appid'));
// 			      $("#game-info-frame").height($(".left-column").height());
				var gameName = $(this).data('game-name');
				var appid = $(this).data('appid');
				console.log(gameName);
				$('<span>')
					.attr('id', 'detailSpinnerHolder')
					.appendTo('#game-info-frame');
// 				var detailSpinnerTarget = $('#detailSpinnerHolder');
// 				$('#spinner-header').after(new Spinner(spinnerOpts).spin().el);
				$.getJSON( '/game?name='+gameName, {
				  })
				    .done(function(data) {
				    	$('#spinner-header').empty();
				    	$('#game-info-frame').empty();
				    	$('<h2>')
			        		.text(data.gameTitle)
			        		.addClass("detail-title")
			        		.appendTo('#game-info-frame');
				    	 $('<img/>')
				        	.addClass('detail-image')
				        	.attr('src', data.imageUrl)
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text(data.overview)
				        	.addClass("detail-overview")
				        	.appendTo('#game-info-frame');
				    	 $('<div>')
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text("Rating: ")
				        	.addClass("detail-rating-label")
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text(data.rating)
				        	.addClass("detail-rating-value")
				        	.appendTo('#game-info-frame');
				    	 $('<div>')
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text("Developer: ")
				        	.addClass("detail-developer-label")
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text(data.developer)
				        	.addClass("detail-develoepr-value")
				        	.appendTo('#game-info-frame');
				    	 $('<div>')
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text("Publisher: ")
				        	.addClass("detail-publisher-label")
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text(data.publisher)
				        	.addClass("detail-publisher-value")
				        	.appendTo('#game-info-frame');
				    	 $('<div>')
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text("Genres: ")
				        	.addClass("detail-genres-label")
				        	.appendTo('#game-info-frame');
				    	 $.each(data.genres, function(j, genre) {
					        	$('<li>')
					    			.text(genre)
					    			.addClass("detail-genre")
					    			.appendTo('#game-info-frame');
				        	});
				    	 $('<div>')
				        	.appendTo('#game-info-frame');
				    	 $('<span>')
				        	.text("Links: ")
				        	.addClass("detail-links-label")
				        	.appendTo('#game-info-frame');
				    	 $('<a>')
				        	.attr('href', "http://store.steampowered.com/app/"+appid)
				        	.text("Steam store")
				        	.addClass("detail-links-value")
				        	.appendTo('#game-info-frame');
				    	 $('<a>')
				        	.attr('href', "http://en.wikipedia.org/wiki/"+gameName+"_(video_game)")
				        	.text("Wikipedia")
				        	.addClass("detail-links-value")
				        	.appendTo('#game-info-frame');
				    	 
			    });
			  });
		}
		
		function registerSearchHandler() {
			$('#filter-input').on('keypress', function(e) {
				//enter
				if (e.keyCode == 13) {
			    	filter($(this).val());
			    //escape
				} else if (e.keyCode == 27) {
					$('#filter-input').val('');
			    	//filter($(this).val());
			    	console.log($('#filter-input'));
				}
			});
		}
		
		$(document).ready(function() {
			registerSearchHandler();
		});
	</script>
    
  </body>
</html>
